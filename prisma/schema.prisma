generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SubscriptionProvider {
  LEMON_SQUEEZY
  APPLE   // App Store
  GOOGLE  // Play Store
}
model User {
  id           String         @id @default(cuid())
  email        String         @unique
  name         String?
  image        String?
  nativeLang   Language       @default(KO)
  targetLevel  Int            @default(1)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  reviewNotes  ReviewNote[]
  solveHistory SolveHistory[]
  // [구독 관리 필드]
  isPro               Boolean   @default(false)
  
  // ★ 핵심: 어디서 결제했는지 기록
  subscriptionProvider SubscriptionProvider? 
  
  // 각 플랫폼의 "구독 고유 ID" (레몬스퀴지는 sub_id, 애플은 original_transaction_id 등)
  subscriptionId      String?
  
  // 상태 (active, cancelled, expired 등)
  subscriptionStatus  String?
  
  // 만료일
  currentPeriodEnd    DateTime?
  
  // 모바일 영수증 검증용 토큰 (애플/구글은 서버 검증 시 이게 필요함)
  purchaseToken       String?   @db.Text

  customerPortalUrl    String?
}

model Problem {
  id                  Int            @id @default(autoincrement())
  level               Int
  type                ProblemType
  subType             ProblemSubType
  language            Language
  question            Json
  options             Json
  explanation         Json
  content             Json
  vocab               Json?
  grammar             Json?
  answerIndex         Int
  audioUrl            String?
  imageUrl            String?
  reasoning_for_level String?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  reviews             ReviewNote[]
  histories           SolveHistory[]
}

model ReviewNote {
  id        Int      @id @default(autoincrement())
  memo      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  userId    String
  problemId Int
  problem   Problem  @relation(fields: [problemId], references: [id])
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, problemId])
}

model SolveHistory {
  id         Int      @id @default(autoincrement())
  isCorrect  Boolean
  userAnswer String?
  timeTaken  Int?
  createdAt  DateTime @default(now())
  userId     String
  problemId  Int
  problem    Problem  @relation(fields: [problemId], references: [id])
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Grammar {
  id                Int      @id @default(autoincrement())
  grammar           String?
  romaji            String?
  meaning_simple    Json?
  levels            Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime
  confusing_factors Json?
  examples          Json?
  explanation       Json?
  hurigana          String?
}

enum Language {
  KO
  EN
  JP
  CN
  VN
}

enum ProblemType {
  VOCAB
  GRAMMAR
  READING
  LISTENING
}

enum ProblemSubType {
  KANJI_READING
  ORTHOGRAPHY
  WORD_FORMATION
  CONTEXT
  PARAPHRASE
  USAGE
  GRAMMAR_FORM
  GRAMMAR_ORDER
  TEXT_GRAMMAR
  SHORT_PASSAGE
  MID_PASSAGE
  LONG_PASSAGE
  INTEGRATED_PASSAGE
  THEMATIC_PASSAGE
  INFO_RETRIEVAL
  TASK_BASED
  POINT_COMPREHENSION
  SUMMARY
  QUICK_RESPONSE
  INTEGRATED_COMPREHENSION
}
